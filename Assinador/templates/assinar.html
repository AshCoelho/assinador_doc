<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Assinatura de Documento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- IMPORTANTE p/ mobile -->
  <link rel="shortcut icon" href="../static/img/brasao_32.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../static/css/assinar.css">

  <!-- pdf.js + worker -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>

{% if show_result %}
<script>
  window.addEventListener('DOMContentLoaded', function () {
    const alvo = document.getElementById('resultado-section');
    if (alvo) alvo.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
</script>
{% endif %}

<body>
  <nav class="container app-header">
    <div class="text-end mb-2">
      <h1 class="app-title">
        <img src="../static/img/logo.png.png" alt="" width="45" height="45">
        Assinatura Digital
      </h1>
    </div>
    <div class="text-end-1 mb-2">
      <span class="usuario">Bem-vindo(a), <strong>{{ nome }}</strong></span>
      <form action="{{ url_for('auth.logout') }}" method="POST" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-danger btn-sm">Sair</button>
      </form>
    </div>
  </nav>

  <div class="container my-5">

    {% if erro %}
      <div class="alert alert-danger">{{ erro }}</div>
    {% endif %}

    <!-- STAGE responsivo (centra o conte√∫do) -->
    <div id="canvasContainer" class="mb-3">
      <div id="stage" class="stage">
        <canvas id="imgCanvas" style="display:none;"></canvas>
        <canvas id="pdfCanvas" style="display:none;"></canvas>
        <div id="assinaturaImagem" class="retangulo" style="display:none;"></div>
        <div id="assinaturaPDF"   class="retangulo" style="display:none;"></div>
      </div>
    </div>

    <form enctype="multipart/form-data" id="formulario" method="post" class="card shadow p-4 bg-white rounded">
      <div><h5>Informa√ß√µes do Documento</h5></div>
      <br/>

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Arquivo -->
      <div class="mb-3">
        <label class="form-label">Arquivo (.png, .jpg, .jpeg, .pdf):</label>
        <input accept=".png,.jpg,.jpeg,.pdf" name="arquivo" onchange="handleFile(this)" required type="file" class="form-control">
      </div>

      <!-- Centralizar -->
      <div class="center-bar mb-3 d-flex gap-2 flex-wrap">
        <button type="button" id="btnCenterH" class="btn btn-outline-primary btn-icon">
          <img width="20" height="20" src="https://img.icons8.com/ios-filled/24/A1A3A6/resize-horizontal.png" alt="">
          Centralizar Horizontal
        </button>
        <button type="button" id="btnCenterV" class="btn btn-outline-primary btn-icon">
          <img width="20" height="20" src="https://img.icons8.com/ios-filled/24/A1A3A6/resize-vertical.png" alt="">
          Centralizar Vertical
        </button>
      </div>

      <!-- Controles de p√°gina (PDF) -->
      <div id="pdfControls" class="mb-3" style="display:none;">
        <label class="form-label">P√°gina do PDF para assinar:</label>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnPrevPage" aria-label="P√°gina anterior">
            &lsaquo;
          </button>
          <input type="number" id="pageInput" class="form-control" style="width:100px" min="1" value="1" aria-label="N√∫mero da p√°gina">
          <span id="pageTotal" class="text-muted">/ 1</span>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnNextPage" aria-label="Pr√≥xima p√°gina">
            &rsaquo;
          </button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Nome do √ìrg√£o:</label>
        <select class="form-select" name="orgao" aria-label="Selecione o √≥rg√£o">
          <option selected>Escolha o Org√£o/Secretaria</option>
          <option value="Secretaria Municipal de Informa√ß√£o e Tecnologia - SEMIT">Secretaria Municipal de Informa√ß√£o e Tecnologia - SEMIT</option>
          <option value="Secretaria Municipal de Administra√ß√£o - SEMAD">Secretaria Municipal de Administra√ß√£o - SEMAD</option>
          <option value="Secretaria Municipal da Sa√∫de - SEMUS">Secretaria Municipal da Sa√∫de - SEMUS</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Setor:</label>
        <input name="setor" type="text" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">Status:</label>
        <input name="status" required type="text" value="Projeto Aprovado" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">N√∫mero do Processo:</label>
        <input name="processo" required type="text" class="form-control">
      </div>

      <!-- Campos ocultos -->
      <input id="x" name="x" type="hidden"/>
      <input id="y" name="y" type="hidden"/>
      <input id="w" name="w" type="hidden"/>
      <input id="h" name="h" type="hidden"/>
      <input id="canvas_w" name="canvas_w" type="hidden"/>
      <input id="canvas_h" name="canvas_h" type="hidden"/>
      <input id="page" name="page" type="hidden" value="1"/>

      <div class="flex-wrap">
        <button class="btn btn-primary" type="submit">‚úî Assinar Documento</button>
        <button class="btn btn-secondary" onclick="location.href='/'" type="button">‚Ü© Voltar</button>
        <button class="btn btn-danger" onclick="resetForm()" type="button">üßπ Limpar</button>
      </div>
    </form>

    {% if show_result %}
    <div id="resultado-section" class="card shadow-sm mt-4">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-primary" href="{{ signed_url }}" target="_blank" rel="noopener">üëÅÔ∏è Ver no navegador</a>
          <a class="btn btn-success" href="{{ url_for('download', filename=arquivo) }}">‚¨á Baixar</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('assinar') }}">‚úçÔ∏è Assinar outro</a>
        </div>

        <p class="text-muted mt-3 mb-1">Arquivo gerado: <code>{{ arquivo }}</code></p>

        <div class="viewer">
          {% if is_pdf %}
            <!-- 1) tenta iframe -->
            <iframe class="pdf-frame" id="resultIframe" src="{{ signed_url }}#toolbar=1&view=FitH" title="Pr√©-visualiza√ß√£o do PDF" loading="lazy"></iframe>

            <!-- 2) fallback: object -->
            <object data="{{ signed_url }}" type="application/pdf" class="pdf-object d-none" id="resultObject"></object>

            <!-- 3) fallback final: pdf.js render 1¬™ p√°gina -->
            <canvas id="resultCanvas" class="d-none" style="width:100%;height:auto;"></canvas>

            <!-- Mensagem de fallback -->
            <div class="pdf-fallback d-none" id="resultFallback">
              Seu navegador n√£o consegue exibir o PDF embutido. Use os bot√µes acima para <a href="{{ signed_url }}" target="_blank" rel="noopener">abrir</a> ou <a href="{{ url_for('download', filename=arquivo) }}">baixar</a>.
            </div>
          {% else %}
            <img class="img-preview" src="{{ signed_url }}" alt="Documento assinado">
          {% endif %}
        </div>

        <p class="text-muted mt-3 mb-0">Se preferir, use ‚ÄúBaixar‚Äù para salvar o arquivo localmente.</p>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- ====== SCRIPT PRINCIPAL (stage + drag + pdfjs na edi√ß√£o) ====== -->
  <!-- (Cole aqui o script que voc√™ j√° est√° usando para o stage/assinatura ‚Äî sem mudan√ßas) -->

  <!-- ====== SCRIPT: fallback mobile do RESULTADO ====== -->
  {% if show_result and is_pdf %}
  <script>
    (function(){
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const iframe   = document.getElementById('resultIframe');
      const obj      = document.getElementById('resultObject');
      const canvas   = document.getElementById('resultCanvas');
      const fallback = document.getElementById('resultFallback');
      const url      = "{{ signed_url }}";

      let iframeOk = false;

      function show(el){ el?.classList.remove('d-none'); }
      function hide(el){ el?.classList.add('d-none'); }

      // Se o iframe carregar, √≥timo!
      iframe?.addEventListener('load', () => { iframeOk = true; });
      // Damos um tempinho para ver se o iframe realmente renderizou
      window.setTimeout(() => {
        if (iframeOk && !isMobile) return; // desktop ok

        // Tenta <object>
        hide(iframe);
        show(obj);

        // Espera um pouco; se ainda n√£o render, usa pdf.js
        window.setTimeout(() => {
          // Por experi√™ncia, muitos mobiles n√£o exibem <object> tamb√©m
          hide(obj);
          if (!window['pdfjsLib']) {
            // Sem pdf.js ‚Äì mostra fallback textual
            show(fallback);
            return;
          }
          // Renderiza primeira p√°gina via pdf.js
          tryRenderWithPdfJs(url, canvas, fallback);
        }, 400);
      }, 700);

      function tryRenderWithPdfJs(pdfUrl, canvasEl, fb) {
        const containerWidth = canvasEl.parentElement.clientWidth || 320;
        show(canvasEl);

        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        loadingTask.promise.then(pdf => {
          pdf.getPage(1).then(page => {
            const viewport0 = page.getViewport({ scale: 1.0 });
            const scale = Math.max(0.5, Math.min(2.0, containerWidth / viewport0.width));
            const viewport = page.getViewport({ scale });

            canvasEl.width  = Math.round(viewport.width);
            canvasEl.height = Math.round(viewport.height);

            page.render({ canvasContext: canvasEl.getContext('2d'), viewport }).promise
              .catch(() => { hide(canvasEl); show(fb); });
          }).catch(() => { hide(canvasEl); show(fb); });
        }).catch(() => { hide(canvasEl); show(fb); });
      }
    })();
  </script>
  {% endif %}
</body>
</html>
