<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <title>Assinatura de Documento</title>
    <link rel="shortcut icon" href="../static/img/brasao_32.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/assinatura.css">
    <link rel="stylesheet" href="../static/css/base.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>

{% if show_result %}
<script>
window.addEventListener('DOMContentLoaded', function () {
  const alvo = document.getElementById('resultado-section');
  if (alvo) alvo.scrollIntoView({ behavior: 'smooth', block: 'start' });
});
</script>
{% endif %}

<body>
  <nav class="container app-header">
    <div class="text-end mb-2">
      <h1 class="app-title">
        <img src="../static/img/logo.png.png" alt="" width="45" height="45">
        Assinatura Digital
      </h1>
    </div>
    <div class="text-end-1 mb-2">
      <span class="usuario">Bem-vindo(a), <strong>{{ nome }}</strong></span>
      <form action="{{ url_for('auth.logout') }}" method="POST" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-danger btn-sm">Sair</button>
      </form>
    </div>
  </nav>

  <div class="container my-5">

    {% if erro %}
      <div class="alert alert-danger">{{ erro }}</div>
    {% endif %}

    <div id="canvasContainer" class="mb-3">
      <canvas id="imgCanvas" style="display:none;"></canvas>
      <canvas id="pdfCanvas" style="display:none;"></canvas>
      <div id="assinaturaImagem" class="retangulo" style="display:none;"></div>
      <div id="assinaturaPDF" class="retangulo" style="display:none;"></div>
    </div>

    <form enctype="multipart/form-data" id="formulario" method="post" class="card shadow p-4 bg-white rounded">
      <div>
        <h5>Informa√ß√µes do Documento</h5>
      </div>
      <br/>

      <!-- Centralizar -->
      <div class="center-bar mb-3 d-flex gap-2">
        <button type="button" id="btnCenterH" class="btn btn-outline-primary btn-icon">
          <img width="20" height="20" src="https://img.icons8.com/ios-filled/24/A1A3A6/resize-horizontal.png" alt="">
          Centralizar Horizontal
        </button>
        <button type="button" id="btnCenterV" class="btn btn-outline-primary btn-icon">
          <img width="20" height="20" src="https://img.icons8.com/ios-filled/24/A1A3A6/resize-vertical.png" alt="">
          Centralizar Vertical
        </button>
      </div>

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Arquivo -->
      <div class="mb-3">
        <label class="form-label">Arquivo (.png, .jpg, .jpeg, .pdf):</label>
        <input accept=".png,.jpg,.jpeg,.pdf" name="arquivo" onchange="handleFile(this)" required type="file" class="form-control">
      </div>

      <!-- Controles de p√°gina (aparecem apenas para PDF) -->
      <div id="pdfControls" class="mb-3" style="display:none;">
        <label class="form-label">P√°gina do PDF para assinar:</label>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnPrevPage">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-left-fill" viewBox="0 0 16 16">
            <path d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z"/>
            </svg>
        </button>
          <input type="number" id="pageInput" class="form-control" style="width:100px" min="1" value="1">
          <span id="pageTotal" class="text-muted">/ 1</span>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnNextPage">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
  <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
</svg>
        </button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Nome do √ìrg√£o:</label>
        <select class="form-select" name="orgao" aria-label="Selecione o √≥rg√£o">
          <option selected>Escolha o Org√£o/Secretaria</option>
          <option value="Secretaria Municipal de Informa√ß√£o e Tecnologia - SEMIT">Secretaria Municipal de Informa√ß√£o e Tecnologia - SEMIT</option>
          <option value="Secretaria Municipal de Administra√ß√£o - SEMAD">Secretaria Municipal de Administra√ß√£o - SEMAD</option>
          <option value="Secretaria Municipal da Sa√∫de - SEMUS">Secretaria Municipal da Sa√∫de - SEMUS</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Setor:</label>
        <input name="setor" type="text" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">Status:</label>
        <input name="status" required type="text" value="Projeto Aprovado" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">N√∫mero do Processo:</label>
        <input name="processo" required type="text" class="form-control">
      </div>

      <!-- Campos ocultos -->
      <input id="x" name="x" type="hidden"/>
      <input id="y" name="y" type="hidden"/>
      <input id="w" name="w" type="hidden"/>
      <input id="h" name="h" type="hidden"/>
      <input id="canvas_w" name="canvas_w" type="hidden"/>
      <input id="canvas_h" name="canvas_h" type="hidden"/>
      <input id="page" name="page" type="hidden" value="1"/>

      <div class="d-flex flex-wrap gap-2 justify-content-between mt-4">
        <button class="btn btn-primary" type="submit">‚úî Assinar Documento</button>
        <button class="btn btn-secondary" onclick="location.href='/'" type="button">‚Ü© Voltar</button>
        <button class="btn btn-danger" onclick="resetForm()" type="button">üßπ Limpar</button>
      </div>
    </form>

    {% if show_result %}
    <div id="resultado-section" class="card shadow-sm mt-4">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-primary" href="{{ signed_url }}" target="_blank">üëÅÔ∏è Ver no navegador</a>
          <a class="btn btnÊàêÂäü btn-success" href="{{ url_for('download', filename=arquivo) }}">‚¨á Baixar</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('assinar') }}">‚úçÔ∏è Assinar outro</a>
        </div>

        <p class="text-muted mt-3 mb-1">Arquivo gerado: <code>{{ arquivo }}</code></p>

        <div class="viewer">
          {% if is_pdf %}
            <iframe class="pdf-frame" src="{{ signed_url }}#toolbar=1&view=FitH"></iframe>
          {% else %}
            <img class="img-preview" src="{{ signed_url }}" alt="Documento assinado">
          {% endif %}
        </div>

        <p class="text-muted mt-3 mb-0">
          Se preferir, use ‚ÄúBaixar‚Äù para salvar o arquivo localmente.
        </p>
      </div>
    </div>
    {% endif %}
  </div>

<script>
  const canvasImg = document.getElementById("imgCanvas");
  const canvasPDF = document.getElementById("pdfCanvas");
  const ctxImg = canvasImg.getContext("2d");
  const ctxPDF = canvasPDF.getContext("2d");
  const assinaturaImg = document.getElementById("assinaturaImagem");
  const assinaturaPdf = document.getElementById("assinaturaPDF");
  const container = document.getElementById("canvasContainer");

  // Controles PDF
  const pdfControls = document.getElementById("pdfControls");
  const pageInput   = document.getElementById("pageInput");
  const pageHidden  = document.getElementById("page");
  const pageTotalEl = document.getElementById("pageTotal");
  const btnPrevPage = document.getElementById("btnPrevPage");
  const btnNextPage = document.getElementById("btnNextPage");

  let isDragging = false, alvo = null, offsetX = 0, offsetY = 0;

  // Estado do PDF
  let pdfDoc = null;
  let currentPage = 1;
  let totalPages = 1;

  // --- conte√∫do informativo nos ret√¢ngulos (carimbo) ---
  [assinaturaImg, assinaturaPdf].forEach(function(el){
    if (!el) return;
    el.innerHTML = `
      <div class="stamp-content" aria-label="√Årea da assinatura">
        <div class="stamp-title">√Årea da assinatura</div>
        <div class="stamp-sub">Posicione a assinatura sem cobrir informa√ß√µes importantes.</div>
      </div>
    `;
  });

  function handleFile(input) {
    const file = input.files[0];
    if (!file) return;

    const ext = file.name.split('.').pop().toLowerCase();

    // Reset visual
    canvasImg.style.display = 'none';
    canvasPDF.style.display = 'none';
    assinaturaImg.style.display = 'none';
    assinaturaPdf.style.display = 'none';
    pdfControls.style.display = 'none';
    pdfDoc = null; currentPage = 1; totalPages = 1;

    if (['jpg', 'jpeg', 'png'].includes(ext)) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const image = new Image();
        image.onload = () => {
          canvasImg.width = image.width;
          canvasImg.height = image.height;
          ctxImg.clearRect(0, 0, canvasImg.width, canvasImg.height);
          ctxImg.drawImage(image, 0, 0);

          canvasImg.style.display = 'block';
          assinaturaImg.style.display = 'block';
          alvo = assinaturaImg;

          document.getElementById("canvas_w").value = image.width;
          document.getElementById("canvas_h").value = image.height;
          pageHidden.value = 1; // irrelevante para imagem

          afterCanvasReady();
        };
        image.src = e.target.result;
      };
      reader.readAsDataURL(file);

    } else if (ext === 'pdf') {
      const reader = new FileReader();
      reader.onload = function () {
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument(typedarray).promise.then(doc => {
          pdfDoc = doc;
          totalPages = doc.numPages || 1;
          currentPage = 1;
          pageInput.min = 1;
          pageInput.max = totalPages;
          pageInput.value = 1;
          pageTotalEl.textContent = `/ ${totalPages}`;
          pdfControls.style.display = 'block';
          renderPDFPage(currentPage);
        });
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function renderPDFPage(num) {
    if (!pdfDoc) return;
    pdfDoc.getPage(num).then(page => {
      const viewport = page.getViewport({ scale: 1.0 });
      canvasPDF.width = viewport.width;
      canvasPDF.height = viewport.height;

      ctxPDF.clearRect(0, 0, canvasPDF.width, canvasPDF.height);
      page.render({ canvasContext: ctxPDF, viewport }).promise.then(() => {
        canvasPDF.style.display = 'block';
        assinaturaPdf.style.display = 'block';
        alvo = assinaturaPdf;

        document.getElementById("canvas_w").value = viewport.width;
        document.getElementById("canvas_h").value = viewport.height;
        pageHidden.value = num;

        afterCanvasReady();
      });
    });
  }

  // Drag do carimbo
  [assinaturaImg, assinaturaPdf].forEach(el => {
    el.addEventListener("mousedown", (e) => {
      isDragging = true;
      alvo = e.currentTarget;
      offsetX = e.offsetX;
      offsetY = e.offsetY;
    });
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging || !alvo) return;

    const rect = container.getBoundingClientRect();
    let left = e.clientX - rect.left - offsetX;
    let top  = e.clientY - rect.top  - offsetY;

    left = Math.max(0, Math.min(left, container.scrollWidth  - alvo.offsetWidth));
    top  = Math.max(0, Math.min(top,  container.scrollHeight - alvo.offsetHeight));

    alvo.style.left = `${left}px`;
    alvo.style.top  = `${top}px`;

    const canvasAtual = (canvasPDF.style.display === 'block') ? canvasPDF : canvasImg;
    updateHiddenFromRect(alvo, canvasAtual);
  });

  document.addEventListener("mouseup", () => { isDragging = false; });

  function resetForm() { window.location.reload(); }

  // Atualiza campos ocultos a partir do tamanho visual do canvas
  function updateHiddenFromRect(el, canvasAtual) {
    const canvasRect = canvasAtual.getBoundingClientRect();
    const escalaX = canvasAtual.width  / canvasRect.width;
    const escalaY = canvasAtual.height / canvasRect.height;

    const left = parseFloat(el.style.left || "0");
    const top  = parseFloat(el.style.top  || "0");

    document.getElementById("x").value = Math.round(left * escalaX);
    document.getElementById("y").value = Math.round(top  * escalaY);
    document.getElementById("w").value = Math.round(el.offsetWidth  * escalaX);
    document.getElementById("h").value = Math.round(el.offsetHeight * escalaY);
  }

  // Centraliza√ß√£o
  function centerRect(axis) {
    const canvasAtual = (canvasPDF.style.display === 'block') ? canvasPDF : canvasImg;
    const alvoAtual   = (canvasPDF.style.display === 'block') ? assinaturaPdf : assinaturaImg;
    if (!alvoAtual || canvasAtual.style.display === 'none') return;

    const containerRect = container.getBoundingClientRect();
    const canvasRect = canvasAtual.getBoundingClientRect();

    const aW = alvoAtual.offsetWidth;
    const aH = alvoAtual.offsetHeight;

    const canvasLeft = canvasRect.left - containerRect.left;
    const canvasTop  = canvasRect.top  - containerRect.top;

    let left = parseFloat(alvoAtual.style.left || "0");
    let top  = parseFloat(alvoAtual.style.top  || "0");

    if (axis === 'H' || axis === 'BOTH') left = canvasLeft + (canvasRect.width  - aW) / 2;
    if (axis === 'V' || axis === 'BOTH') top  = canvasTop  + (canvasRect.height - aH) / 2;

    left = Math.max(canvasLeft, Math.min(left, canvasLeft + canvasRect.width  - aW));
    top  = Math.max(canvasTop,  Math.min(top,  canvasTop  + canvasRect.height - aH));

    alvoAtual.style.left = `${left}px`;
    alvoAtual.style.top  = `${top}px`;

    updateHiddenFromRect(alvoAtual, canvasAtual);
  }

  function afterCanvasReady() {
    setTimeout(() => centerRect('H'), 50); // por padr√£o, centraliza no eixo horizontal
  }

  // Bot√µes de centraliza√ß√£o
  document.getElementById("btnCenterH").addEventListener("click", () => centerRect('H'));
  document.getElementById("btnCenterV").addEventListener("click", () => centerRect('V'));

  // Controles de p√°gina
  if (btnPrevPage) btnPrevPage.addEventListener("click", () => {
    if (!pdfDoc) return;
    currentPage = Math.max(1, currentPage - 1);
    pageInput.value = currentPage;
    renderPDFPage(currentPage);
  });

  if (btnNextPage) btnNextPage.addEventListener("click", () => {
    if (!pdfDoc) return;
    currentPage = Math.min(totalPages, currentPage + 1);
    pageInput.value = currentPage;
    renderPDFPage(currentPage);
  });

  if (pageInput) pageInput.addEventListener("change", () => {
    if (!pdfDoc) return;
    const val = parseInt(pageInput.value || "1", 10);
    currentPage = Math.min(Math.max(1, val), totalPages);
    pageInput.value = currentPage;
    renderPDFPage(currentPage);
  });
</script>
</body>
</html>
