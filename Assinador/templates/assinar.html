<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <title>Assinatura de Documento</title>
    <link rel="shortcut icon" href="../static/img/brasao_32.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/assinatura.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>

    {% if show_result %}
    <script>
    // Assim que a p√°gina com resultados carregar, rola at√© a se√ß√£o
    window.addEventListener('DOMContentLoaded', function () {
    const alvo = document.getElementById('resultado-section');
    if (alvo) {
        alvo.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    });
    </script>
    {% endif %}

<body>
    <nav class="container app-header" >
        <div class="text-end mb-2">
            <h1 class="app-title">
            <img src="../static/img/logo.png.png" alt="" width="45" height="45">
            Assinatura Digital
            </h1>
        </div>
        <div class="text-end-1 mb-2">
        <span class="usuario">Bem-vindo(a), <strong>{{ nome }}</strong></span>
                <form action="{{ url_for('auth.logout') }}" method="POST" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button  type="submit" class="btn btn-outline-danger btn-sm">Sair</button>
                </form>
        
        </div>
    </nav>
<div class="container my-5">
    
    {# --- ALERTA DE ERRO (se houver) --- #}
    {% if erro %}
    <div class="alert alert-danger">{{ erro }}</div>
    {% endif %}
    
    <div id="canvasContainer" class="mb-3">
        <canvas id="imgCanvas" style="display:none;"></canvas>
        <canvas id="pdfCanvas" style="display:none;"></canvas>
        <div id="assinaturaImagem" class="retangulo" style="display:none;"></div>
        <div id="assinaturaPDF" class="retangulo" style="display:none;"></div>
    </div>

    <form enctype="multipart/form-data" id="formulario" method="post" class="card shadow p-4 bg-white rounded">
        <div>
            <h5>Informa√ß√µes do Documento</h1>
        </div>
        <br/>
        <div class="center-bar">
            <button type="button" id="btnCenterH" class="btn btn-outline-primary btn-icon">
                <img width="20" height="20" src="https://img.icons8.com/ios-filled/24/A1A3A6/resize-horizontal.png" alt="">
                Centralizar Horizontal
            </button>
            <button type="button" id="btnCenterV" class="btn btn-outline-primary btn-icon">
                <img width="20" height="20" src="https://img.icons8.com/ios-filled/24/A1A3A6/resize-vertical.png" alt="">
                Centralizar Vertical
            </button>
            </div>


        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label class="form-label">Arquivo (.png, .jpg, .jpeg, .pdf):</label>
            <input accept=".png,.jpg,.jpeg,.pdf" name="arquivo" onchange="handleFile(this)" required type="file" class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">Nome do √ìrg√£o:</label>
            <input name="orgao" required type="text" value="Secretaria Municipal de Informa√ß√£o e Tecnologia - SEMIT" class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">Setor:</label>
            <input name="setor" type="text" class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">Status:</label>
            <input name="status" required type="text" value="Projeto Aprovado" class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">N√∫mero do Processo:</label>
            <input name="processo" required type="text" class="form-control">
        </div>

        


        <!-- Campos ocultos -->
        <input id="x" name="x" type="hidden"/>
        <input id="y" name="y" type="hidden"/>
        <input id="w" name="w" type="hidden"/>
        <input id="h" name="h" type="hidden"/>
        <input id="canvas_w" name="canvas_w" type="hidden"/>
        <input id="canvas_h" name="canvas_h" type="hidden"/>

        <div class="d-flex flex-wrap gap-2 justify-content-between mt-4">
            <button class="btn btn-primary" type="submit">‚úî Assinar Documento</button>
            <button class="btn btn-secondary" onclick="location.href='/'" type="button">‚Ü© Voltar</button>
            <button class="btn btn-danger" onclick="resetForm()" type="button">üßπ Limpar</button>
        </div>
    </form>

    {# --- BLOCO DE RESULTADO NA MESMA P√ÅGINA --- #}
    {% if show_result %}
    <div id="resultado-section" class="card shadow-sm mt-4">

    <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-primary" href="{{ signed_url }}" target="_blank">üëÅÔ∏è Ver no navegador</a>
            <a class="btn btn-success" href="{{ url_for('download', filename=arquivo) }}">‚¨á Baixar</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('assinar') }}">‚úçÔ∏è Assinar outro</a>
        </div>

        <p class="text-muted mt-3 mb-1">Arquivo gerado: <code>{{ arquivo }}</code></p>

        <div class="viewer">
        {% if is_pdf %}
            <iframe class="pdf-frame" src="{{ signed_url }}#toolbar=1&view=FitH"></iframe>
        {% else %}
            <img class="img-preview" src="{{ signed_url }}" alt="Documento assinado">
        {% endif %}
        </div>

        <p class="text-muted mt-3 mb-0">
        Se preferir, use ‚ÄúBaixar‚Äù para salvar o arquivo localmente.
        </p>
    </div>
    </div>
    {% endif %}
</div>

<script>
    const canvasImg = document.getElementById("imgCanvas");
    const canvasPDF = document.getElementById("pdfCanvas");
    const ctxImg = canvasImg.getContext("2d");
    const ctxPDF = canvasPDF.getContext("2d");
    const assinaturaImg = document.getElementById("assinaturaImagem");
    const assinaturaPdf = document.getElementById("assinaturaPDF");
    const container = document.getElementById("canvasContainer");

    // Controles (se n√£o existirem, caem como null e tudo bem)
    const chkCenterH = document.getElementById("centerH");
    const chkCenterV = document.getElementById("centerV");
    const btnCenterNow = document.getElementById("centerNow");

    let isDragging = false, alvo = null, offsetX = 0, offsetY = 0;

    // --- injeta conte√∫do informativo nos ret√¢ngulos (card do carimbo) ---
    [assinaturaImg, assinaturaPdf].forEach(function(el){
        if (!el) return;
        el.innerHTML = `
        <div class="stamp-content" aria-label="√Årea da assinatura">
            <div class="stamp-title">√Årea da assinatura</div>
            <div class="stamp-sub">
            Posicione a assinatura de forma que n√£o oculte informa√ß√µes relevantes.
            </div>
        </div>
        `;
    });

    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;

        const ext = file.name.split('.').pop().toLowerCase();

        canvasImg.style.display = 'none';
        canvasPDF.style.display = 'none';
        assinaturaImg.style.display = 'none';
        assinaturaPdf.style.display = 'none';

        if (['jpg', 'jpeg', 'png'].includes(ext)) {
        canvasImg.style.display = 'block';

        const reader = new FileReader();
        reader.onload = function (e) {
            const image = new Image();
            image.onload = () => {
            // desenha a imagem inteira no canvas
            canvasImg.width = image.width;
            canvasImg.height = image.height;
            ctxImg.clearRect(0, 0, canvasImg.width, canvasImg.height);
            ctxImg.drawImage(image, 0, 0);

            // mostra ret√¢ngulo do carimbo
            assinaturaImg.style.display = 'block';
            alvo = assinaturaImg;

            // dimensiona de refer√™ncia para o backend
            document.getElementById("canvas_w").value = image.width;
            document.getElementById("canvas_h").value = image.height;

            afterCanvasReady(); // centraliza automaticamente
            };
            image.src = e.target.result;
        };
        reader.readAsDataURL(file);

        } else if (ext === 'pdf') {
        const reader = new FileReader();
        reader.onload = function () {
            const typedarray = new Uint8Array(this.result);
            pdfjsLib.getDocument(typedarray).promise.then(pdf => {
            pdf.getPage(1).then(page => {
                const scale = 1.0;
                const viewport = page.getViewport({ scale: scale });
                canvasPDF.width = viewport.width;
                canvasPDF.height = viewport.height;

                const renderCtx = { canvasContext: ctxPDF, viewport: viewport };
                ctxPDF.clearRect(0, 0, canvasPDF.width, canvasPDF.height);
                page.render(renderCtx).promise.then(() => {
                canvasPDF.style.display = 'block';
                assinaturaPdf.style.display = 'block';
                alvo = assinaturaPdf;

                document.getElementById("canvas_w").value = viewport.width;
                document.getElementById("canvas_h").value = viewport.height;

                afterCanvasReady(); // centraliza automaticamente
                });
            });
            });
        };
        reader.readAsArrayBuffer(file);
        }
    }

    // Drag
    [assinaturaImg, assinaturaPdf].forEach(el => {
        el.addEventListener("mousedown", (e) => {
        isDragging = true;
        alvo = e.currentTarget;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        });
    });

    document.addEventListener("mousemove", (e) => {
        if (!isDragging || !alvo) return;

        const rect = container.getBoundingClientRect();
        let left = e.clientX - rect.left - offsetX;
        let top  = e.clientY - rect.top  - offsetY;

        left = Math.max(0, Math.min(left, container.scrollWidth  - alvo.offsetWidth));
        top  = Math.max(0, Math.min(top,  container.scrollHeight - alvo.offsetHeight));

        alvo.style.left = `${left}px`;
        alvo.style.top  = `${top}px`;

        const canvasAtual = (canvasPDF.style.display === 'block') ? canvasPDF : canvasImg;
        updateHiddenFromRect(alvo, canvasAtual);
    });

    document.addEventListener("mouseup", () => { isDragging = false; });

    function resetForm() { window.location.reload(); }

    // --- helpers de centraliza√ß√£o/atualiza√ß√£o ---
    function updateHiddenFromRect(el, canvasAtual) {
        const canvasRect = canvasAtual.getBoundingClientRect();
        const escalaX = canvasAtual.width  / canvasRect.width;
        const escalaY = canvasAtual.height / canvasRect.height;

        const left = parseFloat(el.style.left || "0");
        const top  = parseFloat(el.style.top  || "0");

        document.getElementById("x").value = Math.round(left * escalaX);
        document.getElementById("y").value = Math.round(top  * escalaY);
        document.getElementById("w").value = Math.round(el.offsetWidth  * escalaX);
        document.getElementById("h").value = Math.round(el.offsetHeight * escalaY);
    }

    function centralizarRetangulo() {
        const canvasAtual = (canvasPDF.style.display === 'block') ? canvasPDF : canvasImg;
        const alvoAtual   = (canvasPDF.style.display === 'block') ? assinaturaPdf : assinaturaImg;

        if (!alvoAtual || canvasAtual.style.display === 'none') return;

        const containerRect = container.getBoundingClientRect();
        const canvasRect = canvasAtual.getBoundingClientRect();

        const centerH = !chkCenterH || chkCenterH.checked; // se n√£o existir, assume true
        const centerV = !!(chkCenterV && chkCenterV.checked);

        const alvoW = alvoAtual.offsetWidth;
        const alvoH = alvoAtual.offsetHeight;

        // Limites do canvas dentro do container
        const canvasLeft = canvasRect.left - containerRect.left;
        const canvasTop  = canvasRect.top  - containerRect.top;

        let left = parseFloat(alvoAtual.style.left || "0");
        let top  = parseFloat(alvoAtual.style.top  || "0");

        if (centerH) left = canvasLeft + (canvasRect.width  - alvoW) / 2;
        if (centerV) top  = canvasTop  + (canvasRect.height - alvoH) / 2;

        // Clampa nos limites do canvas
        left = Math.max(canvasLeft, Math.min(left, canvasLeft + canvasRect.width  - alvoW));
        top  = Math.max(canvasTop,  Math.min(top,  canvasTop  + canvasRect.height - alvoH));

        alvoAtual.style.left = `${left}px`;
        alvoAtual.style.top  = `${top}px`;

        updateHiddenFromRect(alvoAtual, canvasAtual);
    }

    // Centraliza ao clicar no bot√£o
    if (btnCenterNow) {
        btnCenterNow.addEventListener('click', centralizarRetangulo);
    }

    // Centraliza quando alterna as op√ß√µes
    if (chkCenterH) chkCenterH.addEventListener('change', centralizarRetangulo);
    if (chkCenterV) chkCenterV.addEventListener('change', centralizarRetangulo);

    // Re-centraliza ao redimensionar janela (layout pode mudar)
    window.addEventListener('resize', () => {
        // pequena espera para estabilizar o layout
        setTimeout(centralizarRetangulo, 50);
    });

    // Centraliza automaticamente ap√≥s o canvas estar pronto
    function afterCanvasReady() {
        setTimeout(centralizarRetangulo, 50);
    }

    // Nova fun√ß√£o que centraliza conforme eixo escolhido
function centralizarRetangulo(eixo) {
    const canvasAtual = (canvasPDF.style.display === 'block') ? canvasPDF : canvasImg;
    const alvoAtual   = (canvasPDF.style.display === 'block') ? assinaturaPdf : assinaturaImg;

    if (!alvoAtual || canvasAtual.style.display === 'none') return;

    const containerRect = container.getBoundingClientRect();
    const canvasRect = canvasAtual.getBoundingClientRect();

    const alvoW = alvoAtual.offsetWidth;
    const alvoH = alvoAtual.offsetHeight;

    const canvasLeft = canvasRect.left - containerRect.left;
    const canvasTop  = canvasRect.top  - containerRect.top;

    let left = parseFloat(alvoAtual.style.left || "0");
    let top  = parseFloat(alvoAtual.style.top  || "0");

    if (eixo === 'H') left = canvasLeft + (canvasRect.width  - alvoW) / 2;
    if (eixo === 'V') top  = canvasTop  + (canvasRect.height - alvoH) / 2;

    left = Math.max(canvasLeft, Math.min(left, canvasLeft + canvasRect.width  - alvoW));
    top  = Math.max(canvasTop,  Math.min(top,  canvasTop  + canvasRect.height - alvoH));

    alvoAtual.style.left = `${left}px`;
    alvoAtual.style.top  = `${top}px`;

    updateHiddenFromRect(alvoAtual, canvasAtual);
}

    // Eventos dos novos bot√µes
    document.getElementById("btnCenterH").addEventListener("click", () => centralizarRetangulo('H'));
    document.getElementById("btnCenterV").addEventListener("click", () => centralizarRetangulo('V'));

</script>

</body>
</html>